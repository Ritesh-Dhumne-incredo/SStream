pipeline {
    agent any

    environment {
        DATABRICKS_HOST = 'https://dbc-6289de08-cfb9.cloud.databricks.com'
        DATABRICKS_TOKEN = credentials('DATABRICKS_TOKEN_2') // store your token in Jenkins credentials
    }

    stages {
        stage('Checkout SCM') {
            steps {
                git url: 'https://github.com/Hritik-Incredo/SStream.git', branch: 'main'
            }
        }

        stage('Prepare Notebook JSON') {
            steps {
                script {
                    // Create JSON file for the notebook run
                    def jsonContent = """
                    {
                        "run_name": "Jenkins Notebook Run - Build #${env.BUILD_NUMBER}",
                        "existing_cluster_id": "2236063f6f28e164",
                        "notebook_task": {
                            "notebook_path": "/Workspace/Users/hritik.moon@incredotech.com/SStream/SparkStreaming/API_stream"
                        }
                    }
                    """
                    writeFile file: 'notebook_run.json', text: jsonContent
                }
            }
        }

        stage('Run Databricks Notebook') {
            steps {
                script {
                    // Submit notebook and fail pipeline if errors occur
                    def result = bat(
                        script: 'databricks jobs run-now --json-file @notebook_run.json --wait',
                        returnStatus: true
                    )
                    
                    if (result != 0) {
                        error "Databricks notebook run failed. Check Databricks UI for details."
                    } else {
                        echo "Notebook ran successfully."
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Databricks notebook job finished.'
        }
    }
}
