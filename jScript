pipeline {
    agent any

    environment {
        DATABRICKS_HOST = 'DBH'
        DATABRICKS_TOKEN = credentials('DBT') // Jenkins secret text token
    }

    stages {
        stage('Checkout GitHub Repo') {
            steps {
                git url: 'https://github.com/Hritik-Incredo/SStream.git', branch: 'main'
            }
        }

        stage('Prepare Notebook JSON') {
            steps {
                script {
                    writeFile file: 'notebook_run.json', text: """
                    {
                      "job_id": 216873594474493
                      }
                    }
                    """
                }
            }
        }

        stage('Run Databricks Notebook and Monitor') {
            steps {
                script {
                    // Trigger the notebook and capture output
                    def output = bat(script: 'databricks jobs run-now --json @notebook_run.json', returnStdout: true).trim()
                    echo "Databricks run response: ${output}"

                    // Parse run_id from JSON
                    def json = readJSON text: output
                    def runId = json.run_id
                    echo "Triggered run_id: ${runId}"

                    // Poll job status until it completes
                    def status = ""
                    while (true) {
                        sleep 10  // 10-second interval
                        def runInfoRaw = bat(script: "databricks jobs get --run-id ${runId}", returnStdout: true).trim()
                        def runInfo = readJSON text: runInfoRaw
                        status = runInfo.state.life_cycle_state
                        echo "Current run status: ${status}"

                        if (status == "TERMINATED" || status == "SKIPPED" || status == "INTERNAL_ERROR") {
                            break
                        }
                    }

                    // Check final result
                    def finalInfoRaw = bat(script: "databricks jobs get --run-id ${runId}", returnStdout: true).trim()
                    def finalInfo = readJSON text: finalInfoRaw
                    def resultState = finalInfo.state.result_state
                    echo "Final result_state: ${resultState}"

                    if (resultState != "SUCCESS") {
                        error "Databricks notebook run failed. Check Databricks UI for details."
                    } else {
                        echo "Notebook ran successfully!"
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Databricks notebook job finished.'
        }
    }
}
